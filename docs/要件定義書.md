# Twitch配信ガチャ集計システム 要件定義書

## 1. 目的・範囲
- 目的: 配信中に発生する「たぬえさ」の当たり/大当たりを自動集計し、配信画面（OBS）とDiscordに素早く正確に反映、配信者の手作業を最小化する。
- 範囲: Windows 環境で動作する常駐集計ツール、サーバーレスなブラウザ表示（OBSブラウザソース/通常ブラウザ）、JSONデータ保存、リセット/バックアップ/履歴閲覧、任意のDiscord通知。
- 非範囲: 外部サーバー常時稼働、RDB 導入、手動Excel集計の継続運用。

## 2. 用語
- 当たり: 通常当選。大当たり: 上位当選。ハズレ: 非当選（集計対象外）。
- イラストフラグ: 当たり回数 ≥ 1。GIFフラグ: 当たり回数 ≥ 3 または 大当たり回数 ≥ 1。

## 3. 外部連携・運用環境
- OS: Windows（必要に応じて起動登録。常駐は不要）。
- 連携: たぬえさ（当選時に外部プログラムを起動。引数: 当選者名, 当たりフラグ[0=当たり,1=大当たり]）、OBS（ローカルHTMLのブラウザソース）、Discord（Webhook または Bot）。
- UIは `GET /api/settings` により絵文字・参考画像ラベル（Discord表示）を取得して反映する。
- 秘密情報: `.env.local` に保存し、` .env.example` を提供。最小権限で発行。

## 4. 機能要件
1) 自動集計（必須）
- トリガー: たぬえさが当選時に指定プログラムを起動（外部トリガー）。
- CLIインターフェース: `gacha-update <winnerName> <hitFlag>`（`hitFlag`: `0=当たり`, `1=大当たり`）。
- 仕様: 実行のたびに該当ユーザーの当たり/大当たりを加算し、イラスト/GIFフラグを再計算して保存。
- 入力検証: 空/過長/制御文字の拒否、全角/空白を含む名前の受容（Windowsの引用ルールに準拠）。
- 重複抑止（任意）: 短時間（例: 2秒）に同一引数の連続呼び出しを抑止。

2) 表示（必須）
- ローカルHTML + `data/data.js` を読み込み、次を表示: 当選者名/当たり回数/大当たり回数/イラスト/ GIF。
- 自動更新（例: 3–5秒ごとのキャッシュバスター付き再読込）、並び替え/軽微なフィルタ（当日/累計）。

3) データ保存（必須）
- 現在値: `data/current.json`。
- 表示用: `data/data.js`（例: `window.__GACHA_DATA__ = { users:[...], updatedAt }`）。
- users配列の主な項目: `name, hit, jackpot, flags{illust,gif}, status, present, hasReference, order, done`。
- 履歴: `logs/YYYY-MM-DDThhmmss.json` に当選イベントを追記保存。
 - データ項目: `users[]`（`name, hit, jackpot, flags{illust, gif}`）、`updatedAt`（ISO文字列）。

4) リセット/バックアップ/履歴閲覧（必須）
- リセット時に `backups/YYYY-MM-DD_HH-mm-ss.json` へ現在値を退避、`current.json` を初期化、`data.js` 更新。
- バックアップ一覧をUIで表示し、選択したスナップショットを閲覧（復元は任意オプション、二重確認）。

5) Discord通知（任意ON/OFF）
- 当選発生時にチャンネルへ自動通知。
- まとめ表示の各行フォーマット: `ステータス絵文字 [参考画像あり/なし] ユーザー名`（例: `✅ [参考画像あり] userA`）。
- 将来拡張: 直近メッセージの編集更新。
- 表示行の絵文字は `discordEmoji*`、参考画像ラベルは `discordRefLabelYes/No` を使用。

## 5. 非機能要件
- 可用性: 配信時間中の常時稼働。異常時は自動再試行/ログ出力。
- 性能: 1イベント処理 < 500ms 目安、表示更新 3–5秒間隔。
- 安定性: ローカル動作を基本とし、ネットワーク断でも集計は継続（Discord通知は保留/再送）。
- 運用: インストーラ不要（ポータブル可）。管理者権限不要を推奨。
 - 配布: zip成果物はプロジェクトルートの `app/` に出力し、Git管理対象とする。

## 6. 画面/UI要件（ブラウザ表示）
- カラム: 当選者名｜当たり｜大当たり｜イラスト（✓/✗）｜GIF（✓/✗）。
- ソート: 当たり降順→大当たり降順→名前昇順（既定）。
- 表示例（OBSソース）: `file:///C:/path/to/repo/public/index.html` を参照。

## 7. エラーハンドリング/ログ
- ログ出力: `logs/app.log`（INFO/ERROR）、イベント履歴JSONと分離。
- 失敗時: 再試行（指数バックオフ）、致命的エラーはトースト/通知を表示。
- データ整合: JSON書込はアトミック（テンポラリ→リネーム）。

## 8. 設定
- 例: `config.json` または `.env.local`
  - `REFRESH_INTERVAL_MS=3000` `DISCORD_WEBHOOK_URL=...`
  - `CLI_ENTRY=...`（たぬえさから起動する実行ファイル/スクリプトのフルパス）。
  - Windows引用ルール: ユーザー名に空白や日本語がある場合は二重引用符で囲む。
- 配布物に含める `setting.json` は、リポジトリ直下の現行 `setting.json` をそのまま同梱し、配布時のデフォルトとする（`scripts/package_dist.ps1`）。
 - 配布物には `.env.local` を同梱し、内容は `.env.example` を既定値としてコピーする。

## 9. 受入れ基準（MVP）
- たぬえさから外部プログラムを呼び出すと `data/current.json` が更新される。
- OBS/ブラウザで必要カラムが表示され、数秒毎に最新化される。
- JSON保存により再起動後も状態が維持される。
- リセットでバックアップが作成され、現在値が初期化される。
- 履歴一覧から任意時点のデータを閲覧できる（閲覧専用）。

## 10. 制約・検討事項
- 外部プログラム起動時のクォート/エンコーディング/パス長（Windows）対応。
- バックアップ世代管理/圧縮、権限/パス（OBSのローカル読み込み許可）、トークン管理。
- 将来拡張: 参考画像収集/管理、メッセージ編集、復元機能の正式化。

## 11. 外部トリガーCLI仕様（参考）
- コマンド: `gacha-update <winnerName> <hitFlag>`（`hitFlag`: `0|1`）。
- 例（PowerShell）:
  - `C:\tools\gacha-update.exe "userA" 0`
  - `powershell -File scripts\update_result.ps1 "ユーザーB" 1`
- 終了コード: 正常時 0、異常時 非0（詳細は `logs/app.log` に記録）。
